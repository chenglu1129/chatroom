<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>简易聊天室</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h2 { margin-bottom: 10px; }
        #userCount { font-weight: bold; color: #2e8b57; }
        #chat {
            width: 100%; height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            background: #f9f9f9;
            white-space: pre-wrap;
        }
        #chat .system { color: gray; }
        #chat .self { color: green; }
        #chat .other { color: blue; }
        input, button { padding: 5px; margin: 5px 0; }
    </style>
</head>
<body>

<h2>聊天室</h2>
<div>在线人数：<span id="userCount">0</span> 人</div>
<div>在线用户：
    <ul id="userList"></ul>
</div>

<input type="text" id="nickname" placeholder="请输入昵称"/>
<br>
<div id="chat"></div>
<br>
<input type="text" id="message" placeholder="输入消息"/>
<input type="text" id="targetNickname" placeholder="私聊对象昵称（留空=群聊）"/>
<button onclick="send()">发送</button>

<script>
    const nicknameInput = document.getElementById("nickname");
    const messageInput = document.getElementById("message");
    const chatBox = document.getElementById("chat");
    const userCountSpan = document.getElementById("userCount");
    const userListUl = document.getElementById("userList");

    let nickname = prompt("请输入你的昵称：");
    if (!nickname) {
        alert("昵称不能为空！");
        location.reload();
    }
    nicknameInput.value = nickname;
    nicknameInput.disabled = true;

    const socket = new WebSocket("ws://localhost:8080/chat?nickname=" + encodeURIComponent(nickname));

    socket.onmessage = function (event) {
        console.log("收到消息：", event.data);
        const data = JSON.parse(event.data);

        // 普通群聊消息
        if (data.type === "chat") {
            const content = `[${data.createTime}] ${data.nickname}：${data.message}`;
            appendMessage(content, data.nickname === nickname ? "self" : "other");
        }

        // 系统消息
        else if (data.type === "system") {
            appendMessage(data.content, "system");
        }

        // 在线人数更新
        else if (data.type === "userCount") {
            userCountSpan.textContent = data.content;
        }

        // 在线用户列表更新
        else if (data.type === "userList") {
            updateUserList(data.users);
        }

        // 私聊消息
        else if (data.type === "private") {
            // 1. 自己发出的消息，已经本地显示过，直接忽略
            if (data.fromUser === nickname) {
                return;
            }

            // 2. 如果是发给自己的，才显示
            if (data.toUser === nickname) {
                const displayMessage = `[${data.time}] 私聊来自 ${data.fromUser}：${data.content}`;
                appendMessage(displayMessage, "other");
            }

            // 3. 发给其他人的私聊，什么都不做，直接忽略
        }
    };


    function updateUserList(users) {
        userListUl.innerHTML = "";
        users.forEach(function (user) {
            const li = document.createElement("li");
            li.textContent = user;
            userListUl.appendChild(li);
        });
    }

    function send() {
        const nickname = nicknameInput.value.trim();
        const message = messageInput.value.trim();
        const targetNickname = document.getElementById("targetNickname").value.trim();

        if (!nickname) {
            alert("请先输入昵称！");
            return;
        }
        if (!message) {
            return;
        }

        const time = new Date().toLocaleTimeString();
        const payload = {
            type: targetNickname ? "private" : "chat",
            from: nickname,
            to: targetNickname,
            time: time,
            content: message
        };

        socket.send(JSON.stringify(payload));

        // 本地显示自己消息
        let displayMessage;
        if (targetNickname) {
            displayMessage = `[${time}] 私聊给 ${targetNickname}：${message}`;
        } else {
            displayMessage = `[${time}] ${nickname}：${message}`;
        }
        appendMessage(displayMessage, "self");

        messageInput.value = "";
    }

    function appendMessage(message, type) {
        const div = document.createElement("div");
        div.className = type;
        div.textContent = message;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>
