<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>完整聊天室</title>
    <style>
        /* 基础样式 */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        /* 聊天区域样式 */
        #chat-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        /* 消息显示区域 */
        #message-area {
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        /* 不同类型的消息样式 */
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            word-break: break-word;
        }
        .system-message {
            color: #666;
            font-style: italic;
            background: #eee;
        }
        .self-message {
            background: #e3f2fd;
            margin-left: 20%;
            text-align: right;
        }
        .other-message {
            background: #fff;
            margin-right: 20%;
            border: 1px solid #ddd;
        }
        .private-message {
            background: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        /* 输入区域样式 */
        #input-area {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }

        /* 用户列表样式 */
        #user-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #user-list h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        #users {
            list-style: none;
            padding: 0;
        }
        #users li {
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        #users li:last-child {
            border-bottom: none;
        }

        /* 状态指示器 */
        #status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .online {
            background: #4CAF50;
        }
        .offline {
            background: #f44336;
        }
    </style>
</head>
<body>
<!-- 主容器 -->
<div id="chat-container">
    <h2>聊天室 <span id="status-indicator" class="offline"></span><span id="status-text">离线</span></h2>
    <div>在线人数: <span id="user-count">0</span> 人</div>

    <!-- 消息显示区域 -->
    <div id="message-area"></div>

    <!-- 消息输入区域 -->
    <div id="input-area">
        <input type="text" id="message-input" placeholder="输入消息..." />
        <input type="text" id="target-user" placeholder="私聊用户(留空为群聊)" />
        <button id="send-button">发送</button>
        <button id="load-history">加载历史</button>
        <div style="width: 100%; margin-top: 10px;">
            <input type="file" id="file-upload" style="display: none;" />
            <button id="upload-button">上传文件</button>
            <span id="file-info"></span>
        </div>
    </div>
</div>

<!-- 用户列表区域 -->
<div id="user-list">
    <h3>在线用户</h3>
    <ul id="users"></ul>
</div>

<script>
    // DOM元素
    const messageArea = document.getElementById('message-area');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const targetUserInput = document.getElementById('target-user');
    const userCountSpan = document.getElementById('user-count');
    const userList = document.getElementById('users');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const loadHistoryButton = document.getElementById('load-history');
    const uploadButton = document.getElementById('upload-button');
    const fileUpload = document.getElementById('file-upload');
    const fileInfo = document.getElementById('file-info');

    // 全局变量
    let nickname = '';
    let socket = null;
    let currentPage = 1;
    let selectedFile = null;

    // 初始化函数
    function initialize() {
        // 获取昵称
        nickname = prompt('请输入您的昵称:', '用户' + Math.floor(Math.random() * 1000));
        if (!nickname) {
            alert('必须输入昵称才能进入聊天室');
            return;
        }

        // 连接WebSocket
        connectWebSocket();

        // 绑定事件
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
        loadHistoryButton.addEventListener('click', loadMoreHistory);
        uploadButton.addEventListener('click', function() {
            fileUpload.click();
        });
        fileUpload.addEventListener('change', handleFileSelect);
    }

    // 连接WebSocket
    function connectWebSocket() {
        // 创建WebSocket连接
        // socket = new WebSocket(`ws://${window.location.host}/api/chat?nickname=${encodeURIComponent(nickname)}`);
        socket = new WebSocket("ws://localhost:8080/api/chat?nickname=" + encodeURIComponent(nickname));

        // 连接成功
        socket.onopen = function() {
            updateStatus(true);
            addSystemMessage('系统: 已连接到聊天服务器');
        };

        // 收到消息
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);

            handleIncomingMessage(data);
        };

        // 连接关闭
        socket.onclose = function() {
            updateStatus(false);
            addSystemMessage('系统: 与服务器的连接已断开');
            // 尝试重新连接
            setTimeout(connectWebSocket, 5000);
        };

        // 错误处理
        socket.onerror = function(error) {
            console.error('WebSocket错误:', error);
            addSystemMessage('系统: 连接发生错误');
        };
    }

    // 更新连接状态显示
    function updateStatus(connected) {
        if (connected) {
            statusIndicator.className = 'online';
            statusText.textContent = '在线';
        } else {
            statusIndicator.className = 'offline';
            statusText.textContent = '离线';
        }
    }

    // 处理收到的消息
    function handleIncomingMessage(data) {
        switch (data.type) {
            case 'chat': // 群聊消息
                // 1. 自己发出的消息，已经本地显示过，直接忽略
                if (data.fromUser === nickname) {
                    return;
                }else {
                    addChatMessage(data.fromUser, data.content, data.time, false);
                }

                break;
            case 'private': // 私聊消息
                if (data.toUser === nickname || data.fromUser === nickname) {
                    // 1. 自己发出的消息，已经本地显示过，直接忽略
                    if (data.fromUser === nickname) {
                        return;
                    }

                    // 2. 如果是发给自己的，才显示
                    if (data.toUser === nickname) {
                    addPrivateMessage(data.fromUser, data.toUser, data.content, data.time);
                    }
                }
                break;
            case 'system': // 系统消息
                addSystemMessage(data.content);
                break;
            case 'userCount': // 在线人数更新
                userCountSpan.textContent = data.count;
                break;
            case 'userList': // 用户列表更新
                updateUserList(data.users);
                break;
            case 'history': // 历史消息
                displayHistoryMessages(data.messages);
                break;
            case 'file': // 文件消息
                handleFileMessage(data);
                break;
            default:
                console.warn('未知的消息类型:', data.type);
        }
    }

    // 添加系统消息到聊天区
    function addSystemMessage(message) {
        const div = document.createElement('div');
        div.className = 'message system-message';
        div.textContent = message;
        messageArea.appendChild(div);
        scrollToBottom();
    }

    // 添加普通聊天消息到聊天区
    function addChatMessage(sender, message, timestamp, isSelf) {
        const time = formatTime(timestamp);
        const div = document.createElement('div');
        div.className = `message ${isSelf ? 'self-message' : 'other-message'}`;
        div.innerHTML = `
                <div><strong>${sender}</strong> <small>${time}</small></div>
                <div>${message}</div>
            `;
        messageArea.appendChild(div);
        scrollToBottom();
    }

    // 添加私聊消息到聊天区
    function addPrivateMessage(fromUser, toUser, message, timestamp) {
        const isSelf = fromUser === nickname;
        const otherUser = isSelf ? toUser : fromUser;
        const time = formatTime(timestamp);
        const direction = isSelf ? '发给' : '来自';

        const div = document.createElement('div');
        div.className = 'message private-message';
        div.innerHTML = `
                <div><strong>私聊${direction} ${otherUser}</strong> <small>${time}</small></div>
                <div>${message}</div>
            `;
        messageArea.appendChild(div);
        scrollToBottom();
    }

    // 处理文件消息
    function handleFileMessage(data) {
        const isSelf = data.fromUser === nickname;
        const time = formatTime(data.time);
        const fileSize = formatFileSize(data.fileSize);

        const div = document.createElement('div');
        div.className = `message ${isSelf ? 'self-message' : 'other-message'}`;

        if (data.msgType === 'image') {
            div.innerHTML = `
                    <div><strong>${data.fromUser}</strong> <small>${time}</small></div>
                    <div>发送了一张图片:</div>
                    <img src="${data.fileUrl}" style="max-width: 300px; max-height: 300px; margin-top: 5px;" />
                `;
        } else {
            div.innerHTML = `
                    <div><strong>${data.fromUser}</strong> <small>${time}</small></div>
                    <div>发送了一个文件: <a href="${data.fileUrl}" target="_blank">${data.fileName}</a> (${fileSize})</div>
                `;
        }

        messageArea.appendChild(div);
        scrollToBottom();
    }

    // 更新用户列表
    function updateUserList(users) {
        userList.innerHTML = '';
        users.forEach(user => {
            const li = document.createElement('li');
            li.textContent = user;
            // 点击用户昵称可以快速设置私聊对象
            li.addEventListener('click', () => {
                targetUserInput.value = user;
                messageInput.focus();
            });
            userList.appendChild(li);
        });
    }

    // 发送消息
    function sendMessage() {
        const message = messageInput.value.trim();
        const targetUser = targetUserInput.value.trim();

        if (!message) return;

        const payload = {
            type: targetUser ? 'private' : 'chat',
            fromUser: nickname,
            toUser: targetUser || null,
            content: message,
            time: new Date().toISOString(),
            msgType: 'text'
        };

        // 发送消息
        socket.send(JSON.stringify(payload));

        // 如果是私聊，在本地显示
        if (targetUser) {
            addPrivateMessage(nickname, targetUser, message, new Date().toISOString());
        } else {
            addChatMessage(nickname, message, new Date().toISOString(), true);
        }

        // 清空输入框
        messageInput.value = '';
        messageInput.focus();
    }

    // 加载更多历史消息
    function loadMoreHistory() {
        const payload = {
            type: 'history',
            page: currentPage,
            size: 20
        };
        socket.send(JSON.stringify(payload));
        currentPage++;
    }

    // 显示历史消息
    function displayHistoryMessages(messages) {
        // 临时保存当前滚动位置
        const oldScrollHeight = messageArea.scrollHeight;
        const oldScrollTop = messageArea.scrollTop;

        // 在顶部插入历史消息
        messages.reverse().forEach(msg => {
            if (msg.type === 'chat') {
                addChatMessage(msg.fromUser, msg.content, msg.time, msg.fromUser === nickname);
            } else if (msg.type === 'private') {
                addPrivateMessage(msg.fromUser, msg.toUser, msg.content, msg.time);
            }
        });

        // 恢复滚动位置
        messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight + oldScrollTop;
    }

    // 处理文件选择
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        selectedFile = file;
        fileInfo.textContent = `已选择: ${file.name} (${formatFileSize(file.size)})`;

        // 自动发送文件
        uploadFile();
    }

    // 上传文件
    function uploadFile() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append('file', selectedFile);

        // 显示上传中状态
        fileInfo.textContent = `上传中: ${selectedFile.name}...`;

        fetch('/api/upload', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fileInfo.textContent = '上传成功!';

                    // 构建文件消息
                    const targetUser = targetUserInput.value.trim();
                    const isImage = selectedFile.type.startsWith('image/');

                    const payload = {
                        type: targetUser ? 'private' : 'chat',
                        fromUser: nickname,
                        toUser: targetUser || null,
                        time: new Date().toISOString(),
                        msgType: isImage ? 'image' : 'file',
                        fileName: selectedFile.name,
                        fileUrl: data.fileUrl,
                        fileSize: selectedFile.size
                    };

                    // 发送文件消息
                    socket.send(JSON.stringify(payload));

                    // 本地显示
                    if (isImage) {
                        const imgMsg = {
                            fromUser: nickname,
                            toUser: targetUser,
                            time: new Date().toISOString(),
                            msgType: 'image',
                            fileUrl: data.fileUrl,
                            fileSize: selectedFile.size
                        };
                        handleFileMessage(imgMsg);
                    } else {
                        const fileMsg = {
                            fromUser: nickname,
                            toUser: targetUser,
                            time: new Date().toISOString(),
                            msgType: 'file',
                            fileName: selectedFile.name,
                            fileUrl: data.fileUrl,
                            fileSize: selectedFile.size
                        };
                        handleFileMessage(fileMsg);
                    }

                    // 重置文件选择
                    selectedFile = null;
                    fileUpload.value = '';
                    setTimeout(() => fileInfo.textContent = '', 2000);
                } else {
                    fileInfo.textContent = '上传失败: ' + data.message;
                }
            })
            .catch(error => {
                console.error('上传错误:', error);
                fileInfo.textContent = '上传出错: ' + error.message;
            });
    }

    // 辅助函数: 滚动到底部
    function scrollToBottom() {
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // 辅助函数: 格式化时间
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
    }

    // 辅助函数: 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 初始化应用
    initialize();
</script>
</body>
</html>